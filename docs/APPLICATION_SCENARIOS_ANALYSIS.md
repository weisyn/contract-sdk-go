# 应用场景与合约SDK职责边界分析

**版本**: v1.0  
**创建日期**: 2025-11-11  
**目的**: 全面分析 DeFi、NFT、游戏、治理等应用场景与合约SDK的关系

---

## 📋 目录

1. [问题提出](#问题提出)
2. [架构分层回顾](#架构分层回顾)
3. [应用场景分析](#应用场景分析)
4. [职责边界划分](#职责边界划分)
5. [设计建议](#设计建议)
6. [配图说明](#配图说明)

---

## 🎯 问题提出

**核心问题**：DeFi、NFT、游戏、治理等应用场景，是否应该由合约SDK来提供支撑能力？

**背景**：
- WES 的设计理念：业务语义从区块链剥离，前置到SDK
- 协议层（transaction.proto）只提供固化能力，不包含业务语义
- 合约SDK负责将"输入输出组合模式"转换为"业务语义接口"

**需要明确**：
1. 这些应用场景的本质是什么？
2. 它们应该在哪一层实现？
3. 合约SDK应该提供什么级别的能力？

---

## 🏗️ 架构分层回顾

### WES 完整架构分层

```
┌─────────────────────────────────────────────────────────────┐
│  L5: 应用层（Application Layer）                            │
│  - DeFi DApp、NFT市场、游戏、治理平台                        │
│  - 使用合约SDK + 链下SDK构建完整应用                        │
└─────────────────────────────────────────────────────────────┘
                    ↓ 调用
┌─────────────────────────────────────────────────────────────┐
│  L4: 业务编排层（Business Orchestration Layer）              │
│  - 链下SDK（client-sdk-go/helpers/）                        │
│  - TokenLifecycleService、StakingService、MarketService等   │
│  - 完整的业务逻辑编排（UTXO选择、费用计算、签名等）          │
└─────────────────────────────────────────────────────────────┘
                    ↓ 调用
┌─────────────────────────────────────────────────────────────┐
│  L3: 合约SDK层（Contract SDK Layer）                        │
│  - 合约SDK（contract-sdk-go/helpers/）            │
│  - token.Transfer()、staking.Stake()等业务语义接口         │
│  - 将业务语义映射为输入输出组合                              │
└─────────────────────────────────────────────────────────────┘
                    ↓ 调用
┌─────────────────────────────────────────────────────────────┐
│  L2: 框架层（Framework Layer）                               │
│  - Framework层（contract-sdk-go/framework/）               │
│  - HostABI封装、链式API、类型系统                            │
└─────────────────────────────────────────────────────────────┘
                    ↓ 调用
┌─────────────────────────────────────────────────────────────┐
│  L1: 协议层（Protocol Layer）                                │
│  - transaction.proto                                        │
│  - 3种输出 + 2种输入模式 + 7种锁定条件                      │
│  - 不包含业务语义，只关心 UnlockingProof 匹配               │
└─────────────────────────────────────────────────────────────┘
```

### 关键区别

| 层级 | 定位 | 职责 | 示例 |
|------|------|------|------|
| **L5 应用层** | 完整应用 | 构建用户可见的DApp | Uniswap、OpenSea、Axie Infinity |
| **L4 业务编排层** | 业务编排 | 完整业务流程编排（链下） | `TokenLifecycleService.Transfer()`（包含UTXO选择、签名） |
| **L3 合约SDK层** | 业务语义 | 业务语义接口（链上） | `token.Transfer()`（只构建交易，不签名） |
| **L2 框架层** | 技术封装 | HostABI封装 | `BeginTransaction().Transfer().Finalize()` |
| **L1 协议层** | 固化能力 | 输入输出组合 | `TxInput` + `TxOutput` |

---

## 🔍 应用场景分析

### 场景分类

#### 1. **基础能力场景**（原子操作）

这些是**不可再分解**的基础业务操作，应该由合约SDK提供：

| 场景 | 基础能力 | 输入输出组合 | 是否应由SDK提供 |
|------|---------|-------------|----------------|
| **代币转账** | Transfer | `1 input + 2 outputs` | ✅ 是 |
| **代币铸造** | Mint | `0 inputs + AssetOutput` | ✅ 是 |
| **代币销毁** | Burn | `N inputs + 0 outputs` | ✅ 是 |
| **代币授权** | Approve | `MultiKeyLock` / `DelegationLock` | ✅ 是 |
| **代币冻结** | Freeze | `TimeLock` / `HeightLock` | ✅ 是 |
| **质押** | Stake | `N inputs + M outputs + ContractLock` | ✅ 是 |
| **解质押** | Unstake | `ContractLock UTXO + 解锁` | ✅ 是 |
| **委托** | Delegate | `DelegationLock` | ✅ 是 |

**判断标准**：
- ✅ 可以映射为单一的输入输出组合模式
- ✅ 是其他复杂场景的基础构建块
- ✅ 不包含特定业务逻辑

#### 2. **组合场景**（业务编排）

这些是**多个基础能力的组合**，包含业务逻辑，应该由应用层或业务编排层提供：

| 场景 | 组合能力 | 基础能力组合 | 是否应由SDK提供 |
|------|---------|-------------|----------------|
| **AMM交换** | Swap | Transfer + 价格计算 + 滑点保护 | ❌ 否（应用层） |
| **流动性池** | AddLiquidity | Transfer + 比例计算 + 份额管理 | ❌ 否（应用层） |
| **借贷** | Lending | Transfer + 利率计算 + 清算逻辑 | ❌ 否（应用层） |
| **NFT铸造** | NFT Mint | Mint + 唯一性检查 + 元数据管理 | ⚠️ 部分（基础Mint由SDK提供） |
| **NFT拍卖** | NFT Auction | Transfer + 时间锁 + 竞价逻辑 | ❌ 否（应用层） |
| **游戏战斗** | Game Battle | 状态查询 + 随机数 + 奖励分发 | ❌ 否（应用层） |
| **投票系统** | Voting | StateOutput + 计数逻辑 + 阈值判断 | ⚠️ 部分（基础能力由SDK提供） |
| **多签钱包** | MultiSig Wallet | MultiKeyLock + 审批流程 | ⚠️ 部分（MultiKeyLock由SDK提供） |
| **资产代币化** | RWA Tokenization | Mint + 资产验证 + 元数据管理 | ⚠️ 部分（基础Mint由SDK提供） |
| **价值评估** | RWA Valuation | StateOutput + 预言机 + 估值模型 | ❌ 否（应用层） |
| **收益分配** | RWA Yield Distribution | Transfer + 收益计算 + 分配策略 | ❌ 否（应用层） |
| **合规检查** | RWA Compliance | StateOutput + KYC/AML + 监管框架 | ❌ 否（应用层） |

**判断标准**：
- ❌ 包含复杂的业务逻辑（价格计算、利率计算、游戏规则等）
- ❌ 需要多个基础能力的组合
- ❌ 不同应用有不同的实现方式

#### 3. **应用场景**（完整应用）

这些是**完整的用户应用**，应该由应用开发者基于SDK构建：

| 场景 | 应用类型 | 需要的SDK能力 | 是否应由SDK提供 |
|------|---------|--------------|----------------|
| **Uniswap风格DEX** | DeFi应用 | Transfer、Swap（应用层实现） | ❌ 否 |
| **OpenSea风格NFT市场** | NFT应用 | Transfer、Mint（SDK提供基础能力） | ❌ 否 |
| **Axie Infinity风格游戏** | 游戏应用 | Transfer、状态管理（SDK提供基础能力） | ❌ 否 |
| **Compound风格借贷** | DeFi应用 | Transfer、利率计算（应用层实现） | ❌ 否 |
| **RWA代币化平台** | RWA应用 | Transfer、Mint、Escrow（SDK提供基础能力） | ❌ 否 |

**判断标准**：
- ❌ 是完整的用户应用
- ❌ 包含UI、前端、后端等完整栈
- ❌ 需要应用开发者基于SDK构建

---

## 📊 职责边界划分

### 合约SDK应该提供的：基础能力（原子操作）

```
合约SDK职责边界：
┌─────────────────────────────────────────┐
│  ✅ 合约SDK提供（基础能力）              │
│                                         │
│  Token模块：                             │
│  - Transfer()      - 转账               │
│  - Mint()          - 铸造               │
│  - Burn()          - 销毁               │
│  - Approve()       - 授权               │
│  - Freeze()        - 冻结               │
│  - Airdrop()       - 空投               │
│                                         │
│  Staking模块：                          │
│  - Stake()         - 质押               │
│  - Unstake()       - 解质押             │
│  - Delegate()      - 委托               │
│  - Undelegate()    - 取消委托           │
│                                         │
│  Governance模块（基础）：               │
│  - Propose()       - 创建提案           │
│  - Vote()          - 投票               │
│                                         │
│  Market模块（基础）：                   │
│  - Escrow()        - 托管               │
│  - Vesting()       - 分阶段释放         │
│                                         │
│  RWA模块（基础能力）：                  │
│  - token.Mint()    - 资产代币化         │
│  - token.Transfer() - 所有权转移        │
│  - market.Escrow() - 资产托管          │
│  - market.Vesting() - 分阶段释放        │
└─────────────────────────────────────────┘
```

### 合约SDK不应该提供的：组合场景和应用场景

```
合约SDK不提供的：
┌─────────────────────────────────────────┐
│  ❌ 应用层实现（组合场景）                │
│                                         │
│  DeFi组合场景：                         │
│  - AMM交换逻辑（价格计算、滑点）         │
│  - 流动性池管理（份额计算、比例）         │
│  - 借贷逻辑（利率计算、清算）            │
│                                         │
│  NFT组合场景：                          │
│  - NFT拍卖逻辑（竞价、时间管理）         │
│  - NFT市场逻辑（版税、手续费）           │
│                                         │
│  ️游戏组合场景：                        │
│  - 游戏战斗逻辑（回合制、随机数）         │
│  - 游戏经济系统（货币、道具交易）         │
│                                         │
│  治理组合场景：                         │
│  - 投票统计逻辑（计数、阈值判断）         │
│  - DAO治理流程（提案→投票→执行）         │
│                                         │
│  RWA组合场景：                          │
│  - 资产验证逻辑（验证机构、文档管理）     │
│  - 价值评估逻辑（预言机、估值模型）       │
│  - 合规检查逻辑（KYC/AML、监管框架）      │
│  - 收益分配逻辑（收益计算、分配策略）     │
└─────────────────────────────────────────┘
```

---

## 🎨 配图说明

### 图1：完整架构分层图

```
┌──────────────────────────────────────────────────────────────┐
│                    L5: 应用层（Application）                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  DeFi    │  │   NFT    │  │  游戏    │  │  治理    │  │
│  │  DApp    │  │  市场    │  │  DApp    │  │  平台    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│         │            │            │            │          │
│         └────────────┴────────────┴────────────┘          │
│                            ↓ 调用                           │
└──────────────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────────────┐
│              L4: 业务编排层（Business Orchestration）         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Token   │  │ Staking  │  │  Market  │  │Governance│  │
│  │ Service │  │ Service  │  │ Service  │  │ Service  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  - 完整业务流程编排（UTXO选择、费用计算、签名）                │
│  - 链下SDK（client-sdk-go/helpers/）                        │
└──────────────────────────────────────────────────────────────┘
                            ↓ 调用
┌──────────────────────────────────────────────────────────────┐
│                  L3: 合约SDK层（Contract SDK）                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  token   │  │ staking  │  │governance│  │  market  │  │
│  │ 模块    │  │  模块    │  │  模块    │  │  模块    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  - 基础能力接口（Transfer、Mint、Stake等）                    │
│  - 将业务语义映射为输入输出组合                                │
│  - 合约SDK（contract-sdk-go/helpers/）              │
└──────────────────────────────────────────────────────────────┘
                            ↓ 调用
┌──────────────────────────────────────────────────────────────┐
│                    L2: 框架层（Framework）                    │
│  - HostABI封装、链式API、类型系统                              │
│  - contract-sdk-go/framework/                                 │
└──────────────────────────────────────────────────────────────┘
                            ↓ 调用
┌──────────────────────────────────────────────────────────────┐
│                    L1: 协议层（Protocol）                     │
│  - transaction.proto                                         │
│  - 3种输出 + 2种输入模式 + 7种锁定条件                        │
│  - 不包含业务语义                                             │
└──────────────────────────────────────────────────────────────┘
```

### 图2：能力边界划分图

```
┌──────────────────────────────────────────────────────────────┐
│              合约SDK能力边界（L3）                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ✅ 提供：基础能力（原子操作）                                │
│  ┌────────────────────────────────────────────────────┐    │
│  │  token.Transfer()   → 1 input + 2 outputs         │    │
│  │  token.Mint()       → 0 inputs + AssetOutput       │    │
│  │  token.Burn()       → N inputs + 0 outputs         │    │
│  │  staking.Stake()    → N inputs + M outputs + Lock │    │
│  │  governance.Vote()  → MultiKeyLock/ThresholdLock  │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ❌ 不提供：组合场景（业务编排）                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  AMM交换逻辑（价格计算、滑点保护）                   │    │
│  │  流动性池管理（份额计算、比例管理）                   │    │
│  │  借贷逻辑（利率计算、清算机制）                       │    │
│  │  NFT拍卖逻辑（竞价、时间管理）                       │    │
│  │  游戏战斗逻辑（回合制、随机数）                       │    │
│  │  投票统计逻辑（计数、阈值判断）                       │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  💡 原则：                                                   │
│  - SDK提供"积木"（基础能力）                                 │
│  - 应用层用"积木"搭建"建筑"（组合场景）                       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 图3：应用场景实现路径图

```
应用场景实现路径：

┌──────────────────────────────────────────────────────────────┐
│  应用场景：Uniswap风格DEX                                     │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  应用层（L5）：                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │  Swap() {                                          │    │
│  │    // 1. 价格计算（应用层逻辑）                      │    │
│  │    price := calculateAMMPrice(...)                 │    │
│  │                                                     │    │
│  │    // 2. 使用SDK基础能力                            │    │
│  │    token.Transfer(from, pool, tokenA, amountA)      │    │
│  │    token.Transfer(pool, to, tokenB, amountB)      │    │
│  │                                                     │    │
│  │    // 3. 滑点保护（应用层逻辑）                      │    │
│  │    checkSlippage(...)                              │    │
│  │  }                                                  │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  依赖的SDK能力（L3）：                                       │
│  ✅ token.Transfer() - SDK提供                              │
│  ❌ calculateAMMPrice() - 应用层实现                         │
│  ❌ checkSlippage() - 应用层实现                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  应用场景：NFT拍卖市场                                        │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  应用层（L5）：                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │  AuctionNFT() {                                    │    │
│  │    // 1. 竞价逻辑（应用层逻辑）                      │    │
│  │    if bid > currentBid {                           │    │
│  │      // 2. 使用SDK基础能力                         │    │
│  │      token.Transfer(bidder, escrow, amount)       │    │
│  │      // 3. 时间管理（应用层逻辑）                    │    │
│  │      extendAuctionTime(...)                        │    │
│  │    }                                                │    │
│  │  }                                                  │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  依赖的SDK能力（L3）：                                       │
│  ✅ token.Transfer() - SDK提供                              │
│  ✅ market.Escrow() - SDK提供（如果实现）                    │
│  ❌ 竞价逻辑 - 应用层实现                                     │
│  ❌ 时间管理 - 应用层实现                                     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 💡 设计建议

### 建议1：明确分层职责

**合约SDK（L3）应该提供**：
- ✅ **基础能力**：Transfer、Mint、Burn、Stake等原子操作
- ✅ **业务语义映射**：将业务语义转换为输入输出组合
- ✅ **类型安全**：提供类型安全的API

**合约SDK（L3）不应该提供**：
- ❌ **业务逻辑**：价格计算、利率计算、游戏规则等
- ❌ **组合场景**：AMM、借贷、NFT拍卖等完整业务流程
- ❌ **应用场景**：完整的DApp实现

### 建议2：应用场景的实现方式

**方式1：应用层直接使用SDK基础能力**

```go
// 应用层：Uniswap风格DEX
func Swap(tokenA, tokenB TokenID, amountIn Amount) {
    // 1. 应用层：价格计算
    price := calculateAMMPrice(tokenA, tokenB, amountIn)
    amountOut := amountIn * price
    
    // 2. SDK：基础能力
    token.Transfer(caller, pool, tokenA, amountIn)
    token.Transfer(pool, caller, tokenB, amountOut)
    
    // 3. 应用层：滑点保护
    checkSlippage(amountOut, expectedAmount)
}
```

**方式2：业务编排层提供组合能力（链下SDK）**

```go
// 业务编排层（L4）：AMM服务
func (s *MarketService) SwapAMM(req *SwapAMMRequest) {
    // 1. 业务编排：价格计算
    price := s.calculateAMMPrice(...)
    
    // 2. 调用合约SDK：基础能力
    // （通过合约调用实现）
    
    // 3. 业务编排：UTXO选择、费用计算、签名
    // （链下SDK完成）
}
```

### 建议3：SDK能力扩展原则

**扩展SDK能力时，应该问**：
1. ✅ 这是原子操作吗？（可以映射为单一输入输出组合）
2. ✅ 这是其他场景的基础构建块吗？
3. ✅ 不包含特定业务逻辑吗？

**如果答案都是"是"，则应该由SDK提供**。

**示例判断**：

| 能力 | 原子操作？ | 基础构建块？ | 无业务逻辑？ | 是否应由SDK提供 |
|------|-----------|-------------|-------------|----------------|
| Transfer | ✅ | ✅ | ✅ | ✅ 是 |
| Mint | ✅ | ✅ | ✅ | ✅ 是 |
| Stake | ✅ | ✅ | ✅ | ✅ 是 |
| AMM Swap | ❌ | ❌ | ❌ | ❌ 否 |
| NFT Auction | ❌ | ❌ | ❌ | ❌ 否 |
| Game Battle | ❌ | ❌ | ❌ | ❌ 否 |
| Voting | ⚠️ | ✅ | ⚠️ | ⚠️ 部分（基础Vote由SDK提供） |

---

## 📋 总结

### 核心结论

1. **合约SDK应该提供**：基础能力（原子操作）
   - Transfer、Mint、Burn、Stake等
   - 可以映射为单一输入输出组合的操作
   - 不包含特定业务逻辑

2. **合约SDK不应该提供**：组合场景和应用场景
   - AMM交换、借贷、NFT拍卖等
   - 包含复杂业务逻辑的场景
   - 完整的DApp实现

3. **应用场景的实现方式**：
   - 应用层基于SDK基础能力构建
   - 或业务编排层（链下SDK）提供组合能力

### 设计原则

**"积木"原则**：
- SDK提供"积木"（基础能力）
- 应用层用"积木"搭建"建筑"（组合场景）

**"原子操作"原则**：
- SDK只提供不可再分解的原子操作
- 组合操作由应用层或业务编排层实现

**"业务语义映射"原则**：
- SDK负责将业务语义映射为输入输出组合
- 不负责业务逻辑的实现

---

## 🔗 相关文档

- [合约SDK README](../README.md)
- [架构设计文档](./ARCHITECTURE_PLAN.md)
- [transaction.proto](../../../pb/blockchain/block/transaction/transaction.proto)

---

**最后更新**: 2025-11-11

