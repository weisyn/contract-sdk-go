# unsafe.Pointer è­¦å‘Šè¯´æ˜

## âš ï¸ è­¦å‘Šä¿¡æ¯

```
possible misuse of unsafe.Pointer [js,wasm]
```

## âœ… çŠ¶æ€ï¼šæ­£å¸¸è­¦å‘Šï¼Œå¯å®‰å…¨å¿½ç•¥

è¿™äº›è­¦å‘Šå‡ºç°åœ¨ä»¥ä¸‹4ä¸ªå‡½æ•°ä¸­ï¼š
- `GetString()` - ç¬¬191è¡Œ
- `GetBytes()` - ç¬¬201è¡Œ
- `AllocateString()` - ç¬¬215è¡Œ
- `AllocateBytes()` - ç¬¬230è¡Œ

## ğŸ“ åŸå› è¯´æ˜

### 1. WASMç¯å¢ƒçš„å¿…è¦ç”¨æ³•

åœ¨WebAssemblyï¼ˆWASMï¼‰ç¯å¢ƒä¸­ï¼Œåˆçº¦ä»£ç è¿è¡Œåœ¨æ²™ç®±ç¯å¢ƒä¸­ï¼Œéœ€è¦é€šè¿‡**çº¿æ€§å†…å­˜ï¼ˆLinear Memoryï¼‰**æ¥è®¿é—®æ•°æ®ã€‚WASMçš„çº¿æ€§å†…å­˜æ˜¯ä¸€ä¸ªè¿ç»­çš„å­—èŠ‚æ•°ç»„ï¼Œåªèƒ½é€šè¿‡æŒ‡é’ˆï¼ˆuint32ï¼‰æ¥è®¿é—®ã€‚

### 2. ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ unsafe.Pointer

- **WASMé™åˆ¶**: WASMæ²¡æœ‰ç›´æ¥çš„å†…å­˜è®¿é—®æœºåˆ¶ï¼Œå¿…é¡»é€šè¿‡ `unsafe.Pointer` å°†æŒ‡é’ˆè½¬æ¢ä¸ºGoçš„å­—èŠ‚æ•°ç»„
- **æ€§èƒ½è¦æ±‚**: ç›´æ¥å†…å­˜è®¿é—®æ˜¯æœ€é«˜æ•ˆçš„æ–¹å¼ï¼Œé¿å…äº†ä¸å¿…è¦çš„å†…å­˜æ‹·è´
- **æ ‡å‡†åšæ³•**: è¿™æ˜¯WASM/WebAssemblyå¼€å‘çš„æ ‡å‡†åšæ³•

### 3. å®‰å…¨æ€§ä¿è¯

ä»£ç å·²ç»æ·»åŠ äº†å®‰å…¨æ£€æŸ¥ï¼š
- âœ… æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥ï¼š`if ptr == 0 || len == 0`
- âœ… é•¿åº¦é™åˆ¶ï¼šä½¿ç”¨ `[:len:len]` ç¡®ä¿ä¸ä¼šè¶Šç•Œ
- âœ… æ³¨é‡Šè¯´æ˜ï¼šæ¯ä¸ªå‡½æ•°éƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜è¿™æ˜¯å¿…è¦çš„ç”¨æ³•

## ğŸ”§ å·²å°è¯•çš„ä¿®å¤æ–¹æ³•

1. âœ… æ·»åŠ äº†å‡½æ•°çº§åˆ«çš„ `//nolint` æ³¨é‡Š
2. âœ… æ·»åŠ äº†è¡Œå†… `//nolint:unsafeptr` æ³¨é‡Š
3. âœ… æ·»åŠ äº†æ–‡ä»¶çº§åˆ«çš„ `//nolint` æ³¨é‡Š

**ç»“æœ**: è­¦å‘Šä»ç„¶å­˜åœ¨ï¼Œå› ä¸ºè¿™æ˜¯IDE linterï¼ˆå¯èƒ½æ˜¯goplsï¼‰çš„é™åˆ¶ï¼Œå®ƒå¯èƒ½ä¸å®Œå…¨æ”¯æŒ `//nolint` æ³¨é‡Šã€‚

## ğŸ’¡ å»ºè®®

### æ–¹æ¡ˆ1ï¼šæ¥å—è­¦å‘Šï¼ˆæ¨èï¼‰

è¿™äº›è­¦å‘Šæ˜¯**æ­£å¸¸çš„**ï¼Œä¸ä¼šå½±å“ä»£ç çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ã€‚å¯ä»¥å®‰å…¨åœ°å¿½ç•¥å®ƒä»¬ã€‚

### æ–¹æ¡ˆ2ï¼šé…ç½®IDE/ç¼–è¾‘å™¨

å¦‚æœä½¿ç”¨VS Codeæˆ–å…¶ä»–ç¼–è¾‘å™¨ï¼Œå¯ä»¥åœ¨è®¾ç½®ä¸­é…ç½®goplsæ¥å¿½ç•¥è¿™äº›è­¦å‘Šï¼š

```json
{
  "gopls": {
    "analyses": {
      "unsafeptr": false
    }
  }
}
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ .golangci.yml

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.golangci.yml` é…ç½®æ–‡ä»¶ï¼š

```yaml
linters-settings:
  staticcheck:
    checks: ["-SA1019"]  # å¿½ç•¥unsafe.Pointerè­¦å‘Š

issues:
  exclude-rules:
    - path: _sdks/contract-sdk-go/framework/contract_base.go
      linters:
        - staticcheck
      text: "possible misuse of unsafe.Pointer"
```

## ğŸ“š å‚è€ƒ

- [Go unsafe.Pointer æ–‡æ¡£](https://pkg.go.dev/unsafe#Pointer)
- [WebAssembly çº¿æ€§å†…å­˜](https://webassembly.org/docs/semantics/#linear-memory)
- [TinyGo WASM æ–‡æ¡£](https://tinygo.org/docs/reference/usage/important-options/)

## âœ… ç»“è®º

è¿™äº› `unsafe.Pointer` è­¦å‘Šæ˜¯**æ­£å¸¸çš„**ï¼Œæ˜¯WASMç¯å¢ƒå¼€å‘çš„å¿…è¦ç”¨æ³•ã€‚ä»£ç å·²ç»æ·»åŠ äº†é€‚å½“çš„å®‰å…¨æ£€æŸ¥å’Œæ³¨é‡Šã€‚å¯ä»¥å®‰å…¨åœ°å¿½ç•¥è¿™äº›è­¦å‘Šã€‚

---

**æœ€åæ›´æ–°**: 2025-11-11

